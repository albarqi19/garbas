<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختيار العشوائي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;300;400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fcfcfd;
            --bg-gradient: radial-gradient(circle at center, #ffffff 0%, #eef1f5 100%);
            --accent: #61CCE7;
            --accent-dark: #353765;
            --text-main: #1d1d1f;
            --text-secondary: #86868b;
            --glass: rgba(255, 255, 255, 0.7);
            --border: rgba(0, 0, 0, 0.04);
         --glow: rgba(97, 204, 231, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-gradient);
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            color: var(--text-main);
        }

        /* --- HEADER --- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 20px;
        }

        .header-logo {
            height: 50px;
            width: auto;
        }

        .header-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-main);
            white-space: nowrap;
        }

        /* --- BACKGROUND LAYER --- */
        #stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1;
        }

        .floating-name {
            position: absolute;
            font-size: 1.2rem;
            font-weight: 300;
            color: var(--text-secondary);
            opacity: 0.15;
            white-space: nowrap;
            user-select: none;
            transition: opacity 0.5s ease;
            left: 0;
            right: auto;
        }

        /* --- UI LAYER --- */
        .ui-container {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .ui-container.active {
            justify-content: center;
        }

        .main-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 15;
        }

        #winner-text {
            font-size: 5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            opacity: 0;
            transform: scale(0.8);
            filter: blur(10px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #winner-text.reveal {
            opacity: 1;
            transform: scale(1);
            filter: blur(0px);
            text-shadow: 0 0 40px var(--glow);
        }

        /* --- WELCOME TEXT --- */
        .welcome-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4.5rem;
            font-weight: 600;
            text-align: center;
            color: var(--accent);
            opacity: 0;
            z-index: 5;
            transition: opacity 0.5s ease;
            background: linear-gradient(90deg, #353765, #61CCE7, #353765, #61CCE7, #353765);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s linear infinite;
            max-width: 90%;
            line-height: 1.3;
            pointer-events: none;
        }

        .welcome-text.show {
            opacity: 1;
        }

        .welcome-text.hidden {
            opacity: 0 !important;
            display: none;
        }

        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }

        .shuffle-text {
            position: fixed;
            font-size: 6rem;
            font-weight: 600;
            color: var(--accent-dark);
            opacity: 0;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 80%;
            z-index: 20;
            visibility: hidden;
        }

        .shuffle-text.active {
            visibility: visible;
        }

        /* --- PAPER CONFETTI --- */
        .paper-confetti {
            position: fixed;
            width: 12px;
            height: 18px;
            pointer-events: none;
            z-index: 50;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }

            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* --- CONTROLS --- */
        .controls {
            margin-top: 18rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            flex-wrap: wrap;
            opacity: 1;
        }

        .controls.hidden-initial {
            opacity: 0;
        }

        .controls.bottom {
            position: fixed;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0;
        }

        .controls.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        button {
            background: var(--accent-dark);
            color: white;
            border: none;
            padding: 1.2rem 3rem;
            border-radius: 100px;
            font-family: inherit;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 10px 20px rgba(53, 55, 101, 0.2);
            letter-spacing: 0.05em;
        }

        button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 15px 30px rgba(53, 55, 101, 0.3);
            background: #61CCE7;
            color: var(--accent-dark);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            transform: scale(1);
        }

        .counter {
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.4s ease;
        }

        /* --- MODAL --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .close-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
            transform: scale(1);
        }

        textarea {
            width: 100%;
            min-height: 250px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 1rem;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-main);
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }

        textarea:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.8);
        }

        .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            background: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: #5a5a5f;
        }

        /* --- CELEBRATION AURA --- */
        #canvas-aura {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 800px;
            pointer-events: none;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* --- CONFETTI CANVAS --- */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* --- ANIMATION CLASSES --- */
        .vortex {
            animation: vortexMove 0.8s forwards cubic-bezier(0.7, 0, 0.3, 1);
        }

        @keyframes vortexMove {
            to {
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                filter: blur(20px);
                opacity: 0;
            }
        }

        .light-burst {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 100px 50px white;
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            display: none;
            /* Hidden - effect removed */
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .welcome-text {
                font-size: 2.8rem;
            }

            #winner-text {
                font-size: 3rem;
            }

            .shuffle-text {
                font-size: 3.5rem;
            }

            button {
                padding: 1rem 2rem;
                font-size: 0.9rem;
            }

            .controls.bottom {
                bottom: 2rem;
                flex-direction: column;
            }

            .modal-content {
                padding: 1.5rem;
            }
        }

        @media (max-width: 600px) {
            body,
            html {
                overflow-y: auto;
                overflow-x: hidden;
            }

            .header {
                height: 56px;
                padding: 0 12px;
                gap: 10px;
            }

            .header-logo {
                height: 38px;
            }

            .header-title {
                font-size: 1rem;
            }

            .ui-container {
                padding: 1.5rem 1rem 4rem;
                align-items: stretch;
            }

            .main-display {
                width: 100%;
                padding: 0 1rem;
                top: 45%;
            }

            #winner-text {
                font-size: 2.4rem;
            }

            .welcome-text {
                font-size: 2.2rem;
                max-width: 95%;
            }

            .shuffle-text {
                font-size: 2.8rem;
            }

            .controls {
                width: 100%;
                flex-direction: column;
                gap: 0.8rem;
                margin-top: 16rem;
            }

            .controls.bottom {
                width: calc(100% - 2rem);
                left: 50%;
                transform: translateX(-50%);
                bottom: 1.5rem;
            }

            button {
                width: 100%;
                padding: 0.9rem 1.2rem;
                font-size: 1rem;
            }

            .counter {
                font-size: 0.8rem;
                bottom: 0.5rem;
            }

            #canvas-aura {
                width: 320px;
                height: 320px;
            }

            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        @media (max-width: 480px) {
            .welcome-text {
                font-size: 1.8rem;
            }

            #winner-text {
                font-size: 2rem;
            }

            .shuffle-text {
                font-size: 2.5rem;
            }

            button {
                padding: 0.8rem 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div id="stage"></div>
    <canvas id="canvas-aura"></canvas>
    <canvas id="confetti-canvas"></canvas>

    <!-- Header -->
    <header class="header">
        <img src="شعار_إشراف الدمام بالطول-B5smw9j5.png" alt="الشعار" class="header-logo">
        <span class="header-title">تحفيظ الشرقية - فرع غرب الدمام</span>
    </header>

    <!-- Modal للأسماء -->
    <div class="modal" id="names-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">قائمة الأسماء</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <textarea id="names-textarea"
                placeholder="اكتب كل اسم في سطر منفصل...&#10;مثال:&#10;محمد&#10;فاطمة&#10;علي&#10;سارة"></textarea>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-btn">إلغاء</button>
                <button id="save-names-btn">حفظ</button>
            </div>
        </div>
    </div>

    <div class="ui-container" id="ui-container">
        <!-- Welcome rotating text -->
        <div class="welcome-text" id="welcome-text"></div>

        <div class="main-display">
            <div id="winner-text">--</div>
            <div id="shuffle-display" class="shuffle-text"></div>
            <div id="burst" class="light-burst"></div>
        </div>

        <div class="controls hidden-initial" id="controls">
            <button id="names-btn">الأسماء</button>
            <button id="draw-btn">السحب</button>
        </div>

        <div class="counter" id="stats">0 اسم</div>
    </div>

    <script>
        const stage = document.getElementById('stage');
        const drawBtn = document.getElementById('draw-btn');
        const namesBtn = document.getElementById('names-btn');
        const winnerText = document.getElementById('winner-text');
        const shuffleDisplay = document.getElementById('shuffle-display');
        const statsDisplay = document.getElementById('stats');
        const auraCanvas = document.getElementById('canvas-aura');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const burst = document.getElementById('burst');
        const uiContainer = document.getElementById('ui-container');
        const controls = document.getElementById('controls');
        const welcomeText = document.getElementById('welcome-text');

        // Modal elements
        const namesModal = document.getElementById('names-modal');
        const namesTextarea = document.getElementById('names-textarea');
        const saveNamesBtn = document.getElementById('save-names-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');

        const ctx = auraCanvas.getContext('2d');
        const confettiCtx = confettiCanvas.getContext('2d');

        let names = [];
        let remainingNames = [];
        let floatingElements = [];
        let auraActive = false;
        let particles = [];
        let confettiParticles = [];
        let isDrawing = false;

        // Set canvas sizes
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;

        // --- WELCOME TEXT ROTATION ---
        const welcomeMessages = [
            'المسابقة القرآنية الأولى لفرع غرب الدمام 1447هـ',
            'السحب على 20 جائزة',
            '327 مشاركاً',
            'فالك الفوز'
        ];

        let currentMessageIndex = 0;
        let welcomeInterval = null;

        function showWelcomeText() {
            welcomeText.textContent = welcomeMessages[currentMessageIndex];
            welcomeText.classList.add('show');

            setTimeout(() => {
                welcomeText.classList.remove('show');
            }, 2000);

            currentMessageIndex = (currentMessageIndex + 1) % welcomeMessages.length;
        }

        function startWelcomeRotation() {
            showWelcomeText();
            welcomeInterval = setInterval(showWelcomeText, 2500);

            // Show controls after first cycle (4 messages * 2.5s = 10s)
            setTimeout(() => {
                controls.classList.remove('hidden-initial');
            }, 10000);
        }

        // Start welcome rotation on page load
        startWelcomeRotation();
        confettiCanvas.height = window.innerHeight;

        // --- MODAL LOGIC ---
        namesBtn.addEventListener('click', () => {
            namesModal.classList.add('active');
        });

        closeModalBtn.addEventListener('click', () => {
            namesModal.classList.remove('active');
        });

        cancelBtn.addEventListener('click', () => {
            namesModal.classList.remove('active');
        });

        saveNamesBtn.addEventListener('click', () => {
            const val = namesTextarea.value;
            names = val.split('\n').map(n => n.trim()).filter(n => n !== "");
            remainingNames = [...names];
            statsDisplay.innerText = `${remainingNames.length} اسم`;
            if (names.length > 0) initBackground();
            namesModal.classList.remove('active');
        });

        // Close modal on outside click
        namesModal.addEventListener('click', (e) => {
            if (e.target === namesModal) {
                namesModal.classList.remove('active');
            }
        });

        // --- BACKGROUND DRIFT LOGIC ---
        class FloatingName {
            constructor(name) {
                this.el = document.createElement('div');
                this.el.className = 'floating-name';
                this.el.innerText = name;
                this.reset();
                stage.appendChild(this.el);
            }

            reset() {
                this.x = Math.random() * window.innerWidth;
                this.y = Math.random() * window.innerHeight;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.opacity = 0.1 + Math.random() * 0.2;
                this.el.style.opacity = this.opacity;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < -100) this.x = window.innerWidth + 100;
                if (this.x > window.innerWidth + 100) this.x = -100;
                if (this.y < -100) this.y = window.innerHeight + 100;
                if (this.y > window.innerHeight + 100) this.y = -100;

                this.el.style.transform = `translate(${this.x}px, ${this.y}px)`;
            }

            vortex() {
                this.el.classList.add('vortex');
            }
        }

        function initBackground() {
            floatingElements.forEach(fe => fe.el.remove());
            floatingElements = [];
            // Limit to 15 random names for better performance
            const shuffled = [...names].sort(() => Math.random() - 0.5).slice(0, 15);
            shuffled.forEach(name => {
                floatingElements.push(new FloatingName(name));
            });
        }

        function animateBackground() {
            floatingElements.forEach(fe => fe.update());
            if (auraActive) drawAura();
            if (confettiParticles.length > 0) drawConfetti();
            requestAnimationFrame(animateBackground);
        }

        // --- FIREWORKS CELEBRATION LOGIC ---
        class FireworkParticle {
            constructor(x, y, color, isTrail = false) {
                this.x = x;
                this.y = y;
                this.isTrail = isTrail;

                if (isTrail) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 12 + 6;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.size = Math.random() * 4 + 2;
                    this.gravity = 0.15;
                } else {
                    this.vx = 0;
                    this.vy = -Math.random() * 8 - 10;
                    this.size = 4;
                    this.gravity = 0.2;
                    this.exploded = false;
                }

                this.opacity = 1;
                this.life = 1;
                this.decay = isTrail ? (Math.random() * 0.02 + 0.015) : 0.01;
                this.color = color;
                this.trail = [];
            }

            update() {
                if (!this.isTrail && !this.exploded) {
                    // Rising firework
                    this.vy += this.gravity;
                    this.x += this.vx;
                    this.y += this.vy;

                    // Add trail
                    this.trail.push({ x: this.x, y: this.y, opacity: 0.5 });
                    if (this.trail.length > 10) this.trail.shift();

                    // Explode when slowing down
                    if (this.vy >= -2) {
                        this.exploded = true;
                        this.createExplosion();
                    }
                } else if (this.isTrail) {
                    this.vy += this.gravity;
                    this.x += this.vx;
                    this.y += this.vy;
                    this.life -= this.decay;
                    this.opacity = this.life;
                    this.vx *= 0.98;
                    this.vy *= 0.98;
                }
            }

            createExplosion() {
                const colors = ['#353765', '#61CCE7']; // Brand colors
                const explosionColor = colors[Math.floor(Math.random() * colors.length)];

                for (let i = 0; i < 25; i++) { // Reduced from 50
                    confettiParticles.push(new FireworkParticle(this.x, this.y, explosionColor, true));
                }
                this.life = 0;
            }

            draw(ctx) {
                if (this.life <= 0) return;

                ctx.save();

                if (!this.isTrail && !this.exploded) {
                    // Draw rising firework with trail
                    this.trail.forEach((t, i) => {
                        ctx.globalAlpha = t.opacity * (i / this.trail.length);
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(t.x, t.y, 2, 0, Math.PI * 2);
                        ctx.fill();
                    });

                    ctx.globalAlpha = 1;
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.isTrail) {
                    // Draw explosion particle
                    ctx.globalAlpha = this.opacity;
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size * this.life, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        let celebrationInterval = null;

        function createSparkles() {
            const colors = ['#353765', '#61CCE7']; // Brand colors

            // Launch 3 fireworks from different positions
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const x = window.innerWidth * (0.2 + Math.random() * 0.6);
                    const y = window.innerHeight;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    confettiParticles.push(new FireworkParticle(x, y, color, false));
                }, i * 300);
            }
        }

        // Paper Confetti Effect
        function createPaperConfetti() {
            const colors = ['#353765', '#61CCE7']; // Brand colors
            const confettiCount = 30;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'paper-confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-20px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    document.body.appendChild(confetti);

                    // Remove after animation
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 50);
            }
        }

        function startCelebration() {
            // Clear any existing celebration
            if (celebrationInterval) clearInterval(celebrationInterval);

            // Initial burst
            createSparkles();

            // Continue celebration every 4 seconds (reduced frequency)
            celebrationInterval = setInterval(() => {
                if (confettiParticles.length < 50) { // Reduced limit
                    const colors = ['#353765', '#61CCE7']; // Brand colors
                    const x = window.innerWidth * (0.2 + Math.random() * 0.6);
                    const y = window.innerHeight;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    confettiParticles.push(new FireworkParticle(x, y, color, false));
                }
            }, 4000);
        }

        function stopCelebration() {
            if (celebrationInterval) {
                clearInterval(celebrationInterval);
                celebrationInterval = null;
            }
        }

        function drawConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles = confettiParticles.filter(p => p.life > 0 && !p.exploded || (p.isTrail && p.life > 0));
            confettiParticles.forEach(p => {
                p.update();
                p.draw(confettiCtx);
            });
        }

        // --- CORE LOGIC ---
        drawBtn.addEventListener('click', async () => {
            if (isDrawing) return;
            if (remainingNames.length === 0) {
                if (names.length === 0) {
                    alert('الرجاء إضافة أسماء أولاً');
                    return;
                }
                remainingNames = [...names]; // Reset pool
            }

            isDrawing = true;
            drawBtn.disabled = true;
            auraActive = false;
            winnerText.classList.remove('reveal');
            auraCanvas.style.opacity = '0';

            // Hide welcome text during draw
            welcomeText.classList.add('hidden');
            if (welcomeInterval) {
                clearInterval(welcomeInterval);
            }

            // Stop previous celebration
            stopCelebration();
            confettiParticles = [];

            // Hide controls
            controls.classList.add('hidden');
            uiContainer.classList.add('active');

            // Phase 1: The Blur Shuffle (Vortex)
            floatingElements.forEach(fe => fe.vortex());

            // Phase 2: Acceleration & Centrifuge
            await delay(800);

            // Prepare and show shuffle display
            shuffleDisplay.classList.add('active');
            shuffleDisplay.innerText = '';

            let shuffleCount = 0;
            const shuffleInterval = setInterval(() => {
                shuffleDisplay.style.opacity = '1';
                shuffleDisplay.innerText = names[Math.floor(Math.random() * names.length)];
                const scale = 0.9 + Math.random() * 0.2;
                shuffleDisplay.style.transform = `translate(-50%, -50%) scale(${scale})`;
                shuffleCount++;
            }, 80);

            await delay(2500);
            clearInterval(shuffleInterval);
            shuffleDisplay.style.opacity = '0';
            shuffleDisplay.classList.remove('active');

            // Phase 3: The Impact Reveal
            const winningIndex = Math.floor(Math.random() * remainingNames.length);
            const winner = remainingNames.splice(winningIndex, 1)[0];

            winnerText.innerText = winner;
            winnerText.classList.add('reveal');

            // Start continuous celebration + paper confetti
            startCelebration();
            createPaperConfetti();

            // Post-Reveal UI
            await delay(500);
            controls.classList.remove('hidden');
            controls.classList.add('bottom');

            drawBtn.disabled = false;
            drawBtn.innerText = remainingNames.length === 0 ? "إعادة وسحب" : "السحب التالي";
            statsDisplay.innerText = `${remainingNames.length} اسم متبقي`;

            // Start Aura
            initAura();
            auraActive = true;
            auraCanvas.style.opacity = '1';

            // Cleanup background
            setTimeout(() => {
                initBackground();
            }, 1000);

            isDrawing = false;
        });

        function delay(ms) {
            return new Promise(res => setTimeout(res, ms));
        }

        // --- AURA PARTICLES ---
        function initAura() {
            auraCanvas.width = 800;
            auraCanvas.height = 800;
            particles = [];
            for (let i = 0; i < 40; i++) {
                particles.push({
                    angle: Math.random() * Math.PI * 2,
                    radius: 100 + Math.random() * 50,
                    size: 2 + Math.random() * 4,
                    speed: 0.005 + Math.random() * 0.01,
                    opacity: Math.random()
                });
            }
        }

        function drawAura() {
            ctx.clearRect(0, 0, 800, 800);
            const cx = 400;
            const cy = 400;

            particles.forEach(p => {
                p.angle += p.speed;
                const x = cx + Math.cos(p.angle) * p.radius;
                const y = cy + Math.sin(p.angle) * p.radius;

                ctx.beginPath();
                ctx.arc(x, y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(46, 98, 255, ${p.opacity * 0.3})`;
                ctx.fill();

                // Subtle drift
                p.radius += 0.1;
                if (p.radius > 300) p.radius = 100;
            });
        }

        // --- INITIALIZATION ---
        namesTextarea.value = `إبراهيم ناصر محمد الحارثي
أبوالقاسم محمد حسن محمد علي
احمد سالم خلف الشمري
احمد عبدالله سعد العبداللطيف
أحمد محمود عبدالدايم عبدالحميد
أسامة أحمد السيد عبدالله
أسامة سالم سعد بن مشني
أسامة مصطفى محمد فايد
البراء أحمد العمري
البراء احمد جابر العمري
البراء مهند فائز الرمضان
اليمان عبدالله محمد العايدي
اليمان عبدالمحسن درباع
أمير أيمن عبدالباري حوا
أمين جيث شمس الدين
انس مالك عبدالحافظ الحميري
اياد بن اسعد سليمان الفيفي
براءة عبد المحسن درباع
بهاءالدين عبدالحميد ناصر العبد
تميم خالد محمد الغامدي
تميم سعود ضيف الله العنزي
تميم محمد فهد القاسم
ثامر مسفر عبد الرحمن القحطاني
جهاد أيمن أكرم الزهراني
حاتم محمد سعيد القحطاني
حبيبة احمد جلال الديب
حسام سعد عبدالرحمن الشمراني
حسن سعد مبارك القحطاني
محمد عدنان علي مقبل
محمد علي جمعان الغامدي
محمد نايف محمد الكرين
محمد هشام محمد عبد العزيز عامر
محمود مبارك محمود يوسف
أحمد محمد عبدالله المجحد
الوليد يحي حسن المالكي
أمير حسام ناصر العبظ
أنس حمدي محمود عبدالدايم عبدالحميد
انس خالد كرم ابو الحسن
أنس ياسر عشري عبد الحميد
إياد محمد أبوبكر الخولي
بدر أمير محمد سعيد
بدر محمد عبدالله المطيري
بسام عبدالله غرمان الشهري
بلال محمد طلعت محمد
حاتم طارق سعيد آل ثابت
حازم ياسر حامد
حمزة ابو الفتوح محمد ابو الفتوح
راكان محمد مضحي العطالله
سطام محمد فالح الهاجري
سعد احمد علي القحطاني
سعد محمد مطلق العتيبي
سعد منصور سعد السعيد
سعد ناصر سعد الرماح
سعود بن صالح بن محمد القحطاني
سعيد احمد سعيد ال معدي
سفيان عمر محمد قشيوط
سلطان حسن حمد مجربي
سلطان سعود عبدالله العنزي
سلطان محمدكوثر محمدشريف
سلمان بن صالح بن محمد القحطاني
صالح علي صالح الشازبي
ضاري محمد يحيى السعدون
ضياء مروان محمد سيف الدين
عبد الإله عبد الله العنزي
عبدالرحمن احمد علي السالم
عبدالعزيز بن عبداللطيف بن عامر الرشادي القحطاني
عبدالكريم سعيد حردان
عبدالله سعد مبارك القحطاني
عبدالله سعود مخلد العتيبي
عبدالله عبدالرحمن عبدالله القحطاني
عدي محمد حاتم عبد المنعم سفور
عزام تركي محمد المحضار
علي عثمان علي الغامدي
عمار صلاح الزهراني
عمار ياسر برك برباع
عمر ابو الفتوح محمد ابو الفتوح
عمر أحمد محمد عزب
احمد حمد العبد المحمد
تميم أحمد منصور ابوزوعة
راكان عبدالعزيز عيسى مجرشي
سعود زكريا الخليفه
سعيد علي سعيد آل سلمان
حسين محمد القحطاني
حمزة أحمد محمد عزب
حمزة عمر حسين محمد
خالد انس محمد البيكي
خالد عبدالرحمن خالد الجبر
خالد عثمان محمد إبراهيم
خالد محمد عبدالهادي العبدالهادي
ريان خالد عبدالله العايدي
زايد منصور سعد السعيد
زياد بن اسعد سليمان الفيفي
زياد بن عبدالعزيز بن محمد النونو
زياد طارق نبيل فتحي السيد
زياد عبدالعزيز فهد الضويان
زياد عبده صديق حمدي
زياد محمد أبوبكر الخولي
زين العابدين يوسف زين العابدين احمد
سطام عبدالله سعد سالم القحطاني
سعد بن عبدالله بن سعد العنزي
سعد مسعد سعد الشهري
سفيان بن عبدالرحمن بن حسن الربيع
سلطان إبراهيم عبدالله البكر
سلطان نايف محيل العتيبي
سلمان محمد عبده الحميري
طلال غرمان سعيد العمري
طه محمد صلاح طه محمد حسن
عاصم محمد سعيد الغامدي
عامر محمد خالد المحمد
عبد الرحمن أحمد عبد الرحمن فودة
عبد الرحمن يحيى حنين العبدلي
مسعود بن محمد بن سعود الجعيد
مشاري خالد صالح الزهراني
مشعل عبد العزيز محمد إسلام إبراهيم
معاذ بهاء محمود ابراهيم نصار
معاذ عادل صنهات الحربي
فارس محمود محمد الهمص
فارس مسيب صالح الزهراني
فهد علي جمعان الغامدي
فواز توفيق عبد الرحمن أدم
قصي محمد حاتم عبد المنعم سفور
كرم علاء الدين يوسف صبح
كنان عبدالله محمد العايدي
ماهر محمد ناصر العبد
محمد الدسوقي محمد الحسيني
محمد خالد السيد محمد عبدالوهاب عامر
محمد سابر محمد الدوسري
محمد عبد السلام السعدون
محمد مالك عبدالحافظ الحميري
مروان أحمد حسني عمر
مكي العبيد مكي
مهند رائد محمد الخليفي
نايف عصام عبد الواحد الحزمي
وسيم اياد محمود بيرقدار
ياسين محمد ياسين الشهري
ياسين وليد محمد علي
يوسف محمد عبدالله محمد محمد سيف
يوسف محمد كمال عكيلة
أحمد أمير محمد سعيد
احمد خالد السيد محمد عبدالوهاب عامر
أحمد عصام أحمد شحاته
البراء عمر حسين محمد
اواب بهاء محمود ابراهيم نصار
تميم سعد يونس موسى
حمزة عبدالرحمن عبدالله العيد
عبدالرحمن إبراهيم عبدالعزيز ابوزينه
عبدالرحمن اسامه
عبدالرحمن محمود محمد عامر
عبدالسلام تركي الزغيبي
عبدالعزيز رائد سيف علي قايد
عبدالله حسين عبدالكريم القاضي
عبدالله محمد باوهال
علي محمد علي عبدالرحمن
عمر عبدالمحسن أحمد الكثيري
عمر محمود مصطفى أبو العطا
فراس عادل محمد العمري
مالك أنس جمال السطوحي
معاذ محمد فهيم احمد مجاهد
معاذ يوسف حمد الهبوب
معتصم هشام أبوبكر راشد
سليم عبدالعزيز سليم الزهراني
شائع ناصر شائع الشهراني
عبد الرحمن عبدالله محمد العايدي
عبد القادر عبد الرزاق عبد القادر الحداد
عبدالله علي عبدالعظيم رزق
عبد العزيز طارق سالم الحربي
عبد العزيز عبد الله سليمان النفيسي
عبد الله عمار عبد الله الحضرمي
عبدالحميدحسام ناصرالعبد
عبدالرحمن بن عبدالله بن سالم الحربي
عبدالرحمن خالد عبدالرحمن البواردي
عبدالرحمن عثمان احمد طير
عبدالرحمن غانم عبدالرحمن الحربي
عبدالرحمن محمد العزي مقبل سند
عبدالرحمن محمد محمد فوزي
عبدالعزيز تريحيب نايف الدوسري
عبدالعزيز عبده صديق حمدي
عبدالعزيز فهد عبدالعزيز الكعبور
عبدالله عبدالرحمن صالح اليحيى
عبدالله ابراهيم محمد المحسن
عبدالله أحمد عبدالله الهاشم
عبدالله رابح عبدالله رابح
عبدالله سعود عبدالله العنزي
عبدالله علي هيازع البارقي
عبدالله محمد احمد يادقار
عبدالله محمد عبدالله الشهري
عبيدة راشد
عبيدة عمرو زغلول
عبيدة محمد محمود شحات
عدنان علي مقبل الزبيري
عزام انس حسين العلي
عماد محمد أحمد عماد الدين محمد
عمر سراج عمر العمري
ناصر فاروق ناصر الجويسم
ناصر محمد ناصر العبد
نايف بن سامي بن سعد الجمالين
وائل سمير محمد قدادرية
ياسر سعد مبارك القحطاني
سلطان سعد نايف الميموني
يوسف أسامه عبد المنعم حسن
معاذ اسامه
محمد هيثم الأمين
عبدالله نور رجب أحمد عمر
عبدالرحمن نور رجب أحمد عمر
يوسف أيمن عوض عريبة
عصام عبدالله يحيى العمري
عبدالرحمن خالد أحمد بحول
احمد وليد عطيه رمضان
خطاب محمد سليمان حسين
فيصل تركي علي اليامي
عبدالاله محمد عبدالله باوزير
صفوان منصور مقبل أحمد قاسم
صالح بن أحمد بن صالح السلطان
عبدالكريم بن سعد بن سعود البديع
عبدالملك سعد سعود البديِّع
أسامة أحمد مسعد الحربي
أيمن محمد العزي مقبل سند
تالنت نالبب ناببب نالب
فالح مساعد فالح الدوسري
آدم احمد محمد عبد المنعم
احمد محمد عبداللطيف حسين
أنس محمد سعد عبد السلام عيد
عبد الله يزيد عبد الله الشملان
عبدالرحمن حسين عبدالكريم القاضي
صابر أبوبكر عبدالمطلب الضويحي
يوسف حمدي صابر علي
بسام محمد علي الحنيه
محمد ايمن محمد عبد الحميد
تركي أحمد عمر الجلال
عبدالرحمن بن مناور بن عبدالله المطيري
أمير ماجد شايع موشر
عبدالعزيز إبراهيم عبدالعزيز ابوزينه
حامد معيض حامد القحطاني
محمود محمد السيد الخولي
فوزان بن وليد بن يوسف الصقر
منصور علي منصور علي
مهندحسام ناصر العبد
وليد بن عادل بن محمد العمري
يوسف احمد محمد وردة
يوسف محمد عبدالله الغامدي
إبراهيم محمد عبدالله محمد محمد سيف
أحمد أسامة أحمد عبدالمجيد
احمد ايمن محمد عبد الحميد
عبدالله محمد يوسف الكويتي
عبدالملك نور رجب أحمد عمر
علي عيسى احمد الدليجان
مبارك عبدالله مبارك الهاجري
عمر سعد نايف الميموني
عمر عبدالله العازمي
عمر عبدالله المنصوري
عمر محمد السيد طبره
عمر محمود عمر علي
عمر هشام أبوبكر راشد
عمر وليد إبراهيم خليل
عيسى محمد الخلف
فارس يحيى زاهر العمري
فايز مهند فايز الرمضان
فهد إبراهيم يوسف الحمودي
فهد عبدالعزيز سليم الزهراني
فهد محمد فهد القاسم
فيصل عبدالمنعم بن عبدالعزيز اليوسف
فيصل غانم عوض القحطاني
مازن شتوي صالح القحطاني
مالك أسامة أحمد عبد المجيد
مالك محمد أحمد عماد الدين
مبارك يسلم سالم بامزعب
محمد إبراهيم العواشز
محمد ادم محمد موسي
محمد اياد محمود بيرقدار
محمد حسين خيرو المقداد
محمد حماد يحيى عبده
محمد سلطان منور المطيري
محمد سمير عبدالله الجيبان
محمد طارق نبيل فتحي السيد
محمد عبدالله عبدالكريم زيد
محمد عبدالمحسن أحمد الكثيري
ياسر شتوي صالح القحطاني
يحيى حماد يحيى عبده
يس مصطفى الشحات مصطفى
يوسف أسامة عبد السميع عبد الفتاح
آدم أحمد محمد أحمد
أسامة أحمد محمد أنصاري
البراء أمير محمد سعيد
البراء عبدالحميد ناصر العبد
البراء محمد عبد اللطيف حسين
أنس محمد عبدالرحمن عبدالرحيم أبو زيد
جعفر إلياس بحر أحمد
خالد احمد توفيق
زياد مصطفى الشحات أحمد
زيد عبدالله عبدالكريم زيد
سفيان سعيد شايع القحطاني
سيف تركي الزغيبي
صالح أبوبكر أحمد
صخر عبدالحميد عبداللطيف محمد
عبدالعزيز عماد سعد المغلوث
عبدالملك طارق الحربي
عزام عبدالباسط محمد السفياني
عمر بن محمد بن سعود الجعيد
عمر خالد كرم ابو الحسن
عمر عبدالله فضل المرجي
عمر منصور عبدالله المطلق
عمرسعد عبدالله الشهري
فارس عثمان احمد طير
فالح مهل فالح الهاجري
ليث فادي محمد عادل حجازي
مالك عمر حسين محمد
مجاهد أبوبكر عبدالمطلب الضويحي
محمد أحمد حسني عمر
محمد إسحاق محمد الحسن
محمد حاشر
محمد سراج عمر العمري
محمد عبد المحسن علي الثويني
محمد مصطفى كامل جابر
محمد مصطفى محمد إسماعيل
مصطفى محمود ابراهيم ابراهيم
معاذ أحمد عبد العزيز سليمان
معاذ محمد فرغلي علي
منصور علي مبارك الدوسري
مهند عمار عبد الله الحضرمي
يحيى محمد محمد فوزي سعده
يونس اسلام الخضري وهيب
أحمد محمود عمر علي
أنس حسام الدين محمد العطار
إياد رابح عبدالله رابح
محمود احمد صدقي عبدالعزيز
معاذ محمد عبدالله المجحد
مهند بن محمد بن عبد الله آل متعب`; // 327 names
        names = namesTextarea.value.split('\n').map(n => n.trim()).filter(n => n !== "");
        remainingNames = [...names];
        statsDisplay.innerText = `${remainingNames.length} اسم`;
        initBackground();
        animateBackground();

        // Handle window resize
        window.addEventListener('resize', () => {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        });

    </script>
</body>

</html>